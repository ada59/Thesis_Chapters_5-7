---
title: "Appendix 0 Data Curation"
author: "Eslava, Ada"
date: "21 Nov 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<style>
body {
text-align: justify}
</style>

###**Dataset description:**

This dataset represents the biodiversity of freshwater fish assemblages along the Trans‐Mexican Volcanic Belt, in Central Mexico. This region is the main area of distribution of the Goodeidae, a freshwater fish family endemic of Mexico.
<p>&nbsp;</p>
The dataset contains fish incidence (i.e. presence/absence) data from two time periods: historical - prior to 1989 - and contemporary - year 2005- for a total of 53 sites. These sites represent locations where species in the Goodeidae family have been present in either one or both time periods.
<p>&nbsp;</p>
Historical period: catalog data records of fish incidence were compiled from the collection of the Zoology Museum of the University of Michigan. The compiled fish incidence reports span over a century. The catalog records were completed using information on fish distributions available in the book: Freshwater Fishes of México (Miller, 2005), and local knowledge of the authors (Gesundheit and Mac??as Garcia, 2018). 
<p>&nbsp;</p>
Contemporary period (i.e 2005 survey): The aim of this survey was to obtain a complete inventory of all fish present in each sampling location. Sampling took place always during daylight hours and in 13 different trips over the course of the year 2005. The sampling techniques used included seining (4m2 seine net, 4mm mesh size), trapping (40‐cm‐long minnow traps, 5‐mm mesh size), and setting a gill net (20‐m2 gill net, mesh sizes of 1.3, 5.7, 7.6, and 8.9 cm). These methods were combined in order to sample fish of different sizes and living in different microhabitats. Sampling effort was adapted to the area and characteristics of each site. For more information, see Gesundheit and Mac??as Garcia (2018).
<p>&nbsp;</p>
Gesundheit, P, Mac??as Garcia, C. The role of introduced species in the decline of a highly endemic fish fauna in Central Mexico. Aquatic Conserv: Mar Freshw Ecosyst. 2018; 28: 1384– 1395.
https://doi.org/10.1002/aqc.2927
<p>&nbsp;</p>
Comments:
Efforts were made to achieve the most comprehensive depiction possible of the incidence of freshwater fish species in the surveyed sites in both the historical and the contemporary periods. 

* There are a few things to consider:
    * Possible underrepresentation of some species that are nocturnal (i.e. assemblages were surveyed only during daylight).
    * Possible underrepresentation of a few species that are known to be better sampled with electrofishing, a method that could not be used in these locations. These species are Agonostomus monticola, Sicydium multipunctatum, Ictalurus dugesii, and Ictalurus mexicanus.
    * Possible influence of the sampling season on the probability to find certain fish species.
<p>&nbsp;</p>
#### **Libraries:**

```{r, echo = TRUE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)  
library(rworldmap)
library(readxl)
library(stringdist)
library(hablar)
library(sp)
library(rgeos)
library(GeoRange)
library(kableExtra)
library(fishtree)
library(stringi)
library(data.table)
```
<p>&nbsp;</p>
#### **Read data: **
```{r, echo=TRUE, warning=FALSE, message=FALSE}
rm(list=ls())
locs <- read.csv2("locs_georeferidas.csv", h=T)               # Coordinates data sheet
dtUP <- read_excel("TODO_peces agosto 2010_PGM_Comments.xlsx") # Most up to date data file (Nov 2021)
```
<p>&nbsp;</p>
#### **Data formatting:**
Check the structure of the data files.
```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
# Locs:
dim(locs) 
sum(locs$Localidad=="")
locs <- locs[!locs$Localidad=="",] 

# Data:
dim(dtUP)
sum(dtUP$Localidad=="") 
sum(is.na(dtUP$Localidad))
dtUP <- dtUP[!is.na(dtUP$Localidad),]
head(dtUP, 2L)

# Modify some names with special characters:
names(dtUP) <- sapply(names(dtUP), function(x) stri_trans_general(x, id = "Latin-ASCII")) # Remove Spanish language accents

names(dtUP)[names(dtUP)=="Cuenta...9"] <- "CountHistNatCatalog"        # Native sps count Historical Catalog Records
names(dtUP)[names(dtUP)=="Cuenta...11"] <- "CountHistNatBroad"         # Native sps count Historical Broad Sense (Reconstruction)
names(dtUP)[names(dtUP)=="ampliado - catalogo"] <- "AddedHistNat(B-C)" # Difference sps count Broad Sense - Catalog 
names(dtUP)[names(dtUP)=="Cuenta...17"] <- "CountNat2005"              # Native sps count 2005
names(dtUP)[names(dtUP)=="Cuenta...22"] <- "CountNonNat2005"           # Non-native sps count 2005
names(dtUP) <- gsub(" ", "", names(dtUP), fixed = TRUE)
dtUP <- as.data.frame(dtUP)
class(dtUP)
```
<p>&nbsp;</p>

In order to assign the coordinate pairs to each locality, the name of each site in the "locs" and "dtUP" files must match.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=TRUE}
ClosestMatch = function(string, stringVector){
  stringVector[amatch(string, stringVector, maxDist=Inf)]
} # Function for approximate string matching

# Check there is correct matching of locality names between data frames:
MatchLoc <- ClosestMatch(dtUP$Localidad, locs$Localidad) 
matches <- data.frame(dtUP$Localidad, MatchLoc)

# Flag mismatches in locality names:
matches$Flags <- rep(NA, nrow(matches)) 
vec <- c(1,4,10,12,13,15,17,20,22,25,29,30,32,35,45,47,55,57,60,62,71,79,82)
matches$Flags <- ifelse(rownames(matches) %in% vec, 1 ,matches$Flags)
sum(matches$Flags==1, na.rm=TRUE) 
matchesII <- subset(matches, matches$Flags==1)

# Assign correct locality names to allow data merging:
locs$LocalidadII <- locs$Localidad
locs$LocalidadII <- plyr::revalue(locs$LocalidadII, 
                                  c("Arroyo El Conejo en Rancho El Conejo"="arroyo El Conejo",
                                    "Rio La Eca en La Eca"="rio La Eca",
                                    "Rio Coscomate en Jilotepec"="rio Coscomate",
                                    "Rio Hidalgo en Ex-Hacienda El Porvenir"="canales en El Porvenir",
                                    "Rio Tilostoc en El Salitre"= "rio Tilostoc",
                                    "Rio Yautepec en Yautepec"="rio Yautepec",
                                    "Rio Nexapa en La Galarza"="rio Nexapa",
                                    "Arroyo en Teotihuacan"="Teotihuacan",
                                    "Canales de Xochimilco cerca del embarcadero Caltongo"="canales de Xochimilco",
                                    "Lago de Cuitzeo en La Palma"="lago de Cuitzeo",
                                    "Laguna de Zacapu en Zacapu"="lago de Zacapu",
"Lago de Patzcuaro en Puacuaro"="lago de Patzcuaro",
"Lago de Zirahuen en Aguaverde"="lago de Zirahuen",
"Laguna El Barril en El Barril"="laguna El Barril",
"Arroyo Grande en el Rancho Los Murillos"="rio Ameca en Los Murillos",
"manantial/balneario en Teuchitlan"="manantial/balneario El Rincon",
                                    "Rio Santa Ma. en Santa Ma. Del Rio"="rio Sta Maria",
"Manantiales de La Media Luna"="laguna de La Media Luna",
                                    "Rio Ayuquila en Corcovado"="rio Ayuquila",
                                    "Rio de Comala en Comala"="rio de Comala",
"Rio Cuarenta en Paso de Cuarenta"="rio Cuarenta",
                                    "manantial en Tocumbo" ="manantial/balneario en Tocumbo",
                                    "tributario del Rio Tuxpan"="trib. rio Tuxpan"))

MatchLoc <- ClosestMatch(dtUP$Localidad, locs$LocalidadII) 
new_matches <- data.frame(dtUP$Localidad, MatchLoc)

# Some more names to re-type in order to allow matching: 
locs$LocalidadII <- plyr::revalue(locs$LocalidadII, c("tributario del Rio Tamazula"="trib. rio Tamazula", "presa en Los Vergeles"="Los Vergeles"))
MatchLoc <- ClosestMatch(dtUP$Localidad, locs$LocalidadII) 
new_matches <- data.frame(dtUP$Localidad, MatchLoc) # OK
```
<p>&nbsp;</p>
Create a final dataframe and add all biological information. 
<p>&nbsp;</p>
Translate variable names into English.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
NDT <- data.frame(matrix(ncol = 8, nrow = 83))
NDT[,1] <- dtUP$SALIDA                                                           # Trip (survey 2005)
NDT[,2] <- str_split_fixed(dtUP$MES,"-",3)[,2]                                   # Month (survey 2005)
NDT[,3] <- rep(2005,nrow(NDT))                                                   # Year (2005)
NDT[,4] <- dtUP$Localidad                                                        # Site name I
NDT[,5] <- dtUP$Cuenca                                                           # Basin
NDT[,6] <- locs$Localidad[amatch(dtUP$Localidad, locs$LocalidadII, maxDist=Inf)] # Site name II
NDT[,7] <- locs$Latitud[locs$Localidad %in% NDT$X6]                              # Latitude
NDT[,8] <- locs$Longitud[locs$Localidad %in% NDT$X6]                             # Longitude

rownames(NDT) <- 1:nrow(NDT)

identical(dtUP$Localidad, NDT$X4) #TRUE, same order
NDT <- data.frame(NDT, dtUP[,5:26])
names(NDT) <- c("Trip", "Month", "Year", "SiteName", "DrainageBasin", "SiteNameII", "Latitude", "Longitude", names(dtUP[,5:26]))

names(NDT) <- plyr::revalue(names(NDT),c("NativosEsperadossegunno.decatalogo"="HistoricalNatCatalog","NativosEsperadosampliado"="HistoricalNatBroad","ExoticosEsperadosNEODAT"="HistoricalExotics","fechadecolecta"="DateCollected","no.decolectas"="NumberCollections",
"nativosnoesperados?"="NonExpectedNat?","nativosnoesperados"="NonExpectedNat","mismasriquezas"="SameRichness","ExoticosEncontrados"="ExoticsFound2005","Datosanecdoticos"="Anectodic", "ExtintosoExtirpadosenlaLocalidad"="Extint/ExtirpatedInLoc","Notas"="Comments",
"NativosEncontrados2005"="NativeFound2005","enc/esp"="RatioFound/Expected"))

NDT <- NDT %>% retype()
str(NDT)
```
<p>&nbsp;</p>
Create a column that contains information on the type of water body (using SM of Gesundheit and Macias Garcia, 2018)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
NDT$SiteType <- rep(NA, nrow(NDT))
NDT$SiteName <- stri_trans_general(NDT$SiteName, id = "Latin-ASCII") # Remove accents

# Streams:
NDT$SiteType <- ifelse(NDT$DrainageBasin %in% c("El Salado", "rio Cuitzmala", 
                                                "rio Purificacion",
                                                "rio Cihuatlan", 
                                                "lagunas de Sayula"), "Stream", NDT$SiteType) # All sites in these basins are streams
NDT$SiteType <- ifelse(NDT$SiteName %in% c("rio El Mimbre", "rio Tunal", "rio Sta Maria",
                                           "rio Barranquitas", "rio Yautepec",
                                           "trib. rio Tamazula", "trib. rio Tuxpan",
                                           "rio de Comala", "arroyo La Yerbabuena",
                                           "rio Coscomate", # Assumed
                                           "rio Turbio cerca de El Nopal", "rio Tilostoc",
                                           "rio Lerma cerca de Solis", "trib. del rio 'San Pedro'"), "Stream", NDT$SiteType)

# trib. del rio 'San Pedro' is the same as Tributary to Ayuquila River N of Cofradia de Duendes.
# Correct to the second name as it is more precise:
NDT$SiteName[NDT$SiteName=="trib. del rio 'San Pedro'"] <- "trib. Ayuquila River N of Cofradia de Duendes"

# Impounded streams:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("represa en Hda. San Sebastian",
                                           "arroyo Los Pajaritos"), "Impounded stream", NDT$SiteType)

# Springs:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("manantial en El Toboso", "manantial en 27 de Nov.",
                                           "manantial en Los Berros", "manantial en Puerta del Rio",
                                           "manantial Molino de Chapultepec"), "Spring", NDT$SiteType)
# Small rivers:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("rio 'San Pedro' en Belen del Refugio",
                                           "rio Gde. de Santiago en Ocotlan",
                                           "rio Salado",
                                           "rio Ayutla",
                                           "rio Ameca en La Vega",
                                           "rio Ameca en Los Murillos",
                                           "rio de La Pola",
                                           "rio de La Laja en Atotonilco",
                                           "rio Lerma en Puerto del Valle",
                                           "rio Ayuquila",
                                           "rio Nexapa"), "Small river", NDT$SiteType)
# Shallow lakes:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("lago de Zumpango",
                                           "lago de Chalco",
                                           "Laguna Zempoala",
                                           "lago de Yuriria",
                                           "laguna de Magdalena",
                                           "laguna La Colorada",
                                           "laguna de Sta Maria",
                                           "lago de Zacapu",
                                           "lago de Cuitzeo",
                                           "lago de Patzcuaro",
                                           "lago de Chapala en Mezcala"), "Shallow lake", NDT$SiteType)

# Reservoirs:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("P. Ignacio Ramirez", "P. San Juanico", "P. Cointzio"), "Reservoir", NDT$SiteType)

# Lakes:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("lago de Zirahuen"), "Lake", NDT$SiteType)

# Canals:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("canales de Xochimilco"), 
                       "Open canals shallow lake", NDT$SiteType)
NDT$SiteType <- ifelse(NDT$SiteName %in% c("canales en Zinzimeo", "canales en El Porvenir"), 
                       "Irrigation canals", NDT$SiteType)

# Springs forming small shallow lake:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("laguna de La Minzita", "laguna de La Media Luna"), 
                       "Springs forming small shallow lake", NDT$SiteType)

# Impounded outflow of a system of springs
NDT$SiteType <- ifelse(NDT$SiteName %in% c("P. de Sta Catarina"), 
                       "Impounded outflow system of springs", NDT$SiteType)
# Modified springs:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("balneario Los Rosales",
                                           "manantial/balneario en Tocumbo",
                                           "manantial/balneario El Rincon"), 
                       "Modified spring", NDT$SiteType)

# Not habitable:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("Texcoco 1", "Texcoco 2", "Teotihuacan",
                                           "manantial en Cerro Gordo", 
                                           "manantial El Sacristan",
                                           "trib. del rio Lerma en Tanhuato",
                                           "rio Gde. de Santiago en Poncitlan",
                                           "presa El Gigante", 
                                           "rio Turbio cerca de Manuel Doblado",
                                           "rio Turbio cerca de Cueramaro",
                                           "rio Turbio en San Juan de la Puerta"), "Not habitable",NDT$SiteType) # These include localities that have ceased to exist, that were found dry or with foul water.

sum(is.na(NDT$SiteType)) # OK
# NA: rio en 6 de Enero.
# NA: presa sobre el rio Carrizal 
# NA: rio Cuarenta (considerada un outlier por Pablo & Tino)
# NA: Los Vergeles
```
<p>&nbsp;</p>
* Revise temporal and spatial data:
    * Data were collected in multiple fieldwork trips during 2005 except for May and August (Gesundheit and Mac??as Garcia, 2018)
    * Coordinates fall in the correct geographic area.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
# Temporal:
sort(unique(NDT$Month)) 
sort(unique(NDT$Year))

# Spatial:
world <- getMap(resolution = "low")
Mexmap <- "Mexico"
Mex <- world[world@data$ADMIN %in% "Mexico", ]

range(NDT$Longitude) # Rio Barraquitas missing (-)
NDT$Longitude[NDT$SiteName=="rio Barranquitas"] <- NDT$Longitude[NDT$SiteName=="rio Barranquitas"]*(-1)

range(NDT$Latitude)  # 18.51 24.62
range(NDT$Longitude) # -104.90  -98.45
```

```{r, echo=TRUE, results=TRUE, message=FALSE}
(Mmap <- ggplot() +
    geom_polygon(data = Mex, 
                 aes(x = long, y = lat, group = group),
                 fill = NA, colour = "black") + 
    geom_point(data = NDT,
               aes(x = Longitude, y = Latitude), size=2.5)+
  theme_classic())
```
<p>&nbsp;</p>
* Remove a couple dubious sps observations in the historical assemblage according to data collectors.
    * ?Z. quitzeoensis?) in "manantial Molino de Chapultepec"
    * A. regalis (?) in "manantial/balneario en Tocumbo"
* Add a few species observations:
    * Gambusia senilis considered native in "manantial en 27 de noviembre" despite the records from the historical collectors Humphries y Smith. Miller mentions similar populations possibly of G senilis in the area and, in 2005, the sps was found in two close reservoirs, so it was considered more likely that the species was native and not translocated in this locality.
    * Herichthys cf cyanoguttatus was found in "el manantial en Puerta del Rio" and was considered an introduced species. According to Miller, the sps has been translocated but there are also populations with undetermined taxonomic status. Due to the uncertainty with this one record we removed it from the dataset, also following (Gesundheit and Macias Garcia, 2018).


```{r}
# HistoricalNatCatalog:
NDT$HistoricalNatCatalog[NDT$SiteName=="manantial/balneario en Tocumbo"] <- "C. pardalis" # String without A.regalis

# HistoricalNatBroad:
NDT$HistoricalNatBroad[NDT$SiteName=="manantial Molino de Chapultepec"] <- "A. diazi, G. atripinnis, S. lermae, A. dugesii, (A. robustus?, X. variata" # String without Z. quitzeoensis
NDT$HistoricalNatBroad[NDT$SiteName=="manantial/balneario en Tocumbo"] <- "G. atripinnis, C. pardalis" # String without A.regalis

# Check G. cf. senilis (manantial en 27 de noviembre):
NDT$HistoricalNatCatalog[NDT$SiteName=="manantial en 27 de Nov."]
NDT$HistoricalNatBroad[NDT$SiteName=="manantial en 27 de Nov."]
NDT$HistoricalExotics[NDT$SiteName=="manantial en 27 de Nov."]

# Remove "Herichthys cf cyanoguttatus":
NDT$ExoticsFound2005[NDT$SiteName=="manantial en Puerta del Rio"]
NDT$ExoticsFound2005[NDT$SiteName=="manantial en Puerta del Rio"] <- "Oreochromis sp., P. mexicana"
```
<p>&nbsp;</p>
Translate site & basin Spanish names according to Gesundheit & Macias-Garcia (2018):

```{r, echo=TRUE}
sort(unique(NDT$DrainageBasin))

NDT$DrainageBasinE <- NA
NDT$SiteNameE <- NA

NDT$DrainageBasinE <- plyr::revalue(NDT$DrainageBasin, c("alto Lerma"="Upper Lerma",
                                                        "de Mexico"="Valley of Mexico",
                                                        "El Salado"="El Salado",
                                                        "lago de Cuitzeo"="Lake Cuitzeo",
                                                        "lago de Patzcuaro"="Lake Patzcuaro",
                                                        "lago de Yuriria"="Lake Yuriria",
                                                        "lagunas de Sayula"="Sayula lagoons",
                                                        "medio Lerma"="Middle Lerma",
                                                        "rio Ameca"="Ameca River",
                                                        "rio Armeria"="Armeria River",
                                                        "rio Balsas"="Balsas River",
                                                        "rio Cihuatlan"="Cihuatlan River",
                                                        "rio Cuitzmala"="Cuitzmala River",
                                                        "rio Gde. de Santiago"="Grande de Santiago",
                                                        "rio Naranjo - Coahuayana"="Coahuayana River",
                                                        "rio Panuco"="Panuco River",
                                                        "rio Purificacion"="Purificacion River",
                                                        "rio San Pedro Mezquital"="San Pedro Mezquital", "bajo Lerma"="Lower Lerma", "lago de Zirahuen"="Lake Zirahuen"))
sort(unique(NDT$DrainageBasinE))

sort(unique(NDT$SiteName))
NDT$SiteNameE <- plyr::revalue(NDT$SiteName, c("arroyo El Conejo"="El Conejo Stream",
                                               "arroyo en Acatlan"="Stream at Acatlan de Juarez",
                                               "arroyo en Agua de Enmedio"="Stream at Agua de Enmedio",
                                               "arroyo La Yerbabuena"="La Yerbabuena Stream",
                                               "arroyo Los Pajaritos"="Los Pajaritos Stream",
                                               "balneario Los Rosales"="Balneario Los Rosales",
                                               "canales de Xochimilco"="Xochimilco Canals",
                                               "canales en Zinzimeo"="Zinzimeo Canals",
                                               "lago de Chalco"="Lake Chalco",
                                               "lago de Yuriria"="Lake Yuriria",
                                               "lago de Zacapu"="Zacapu Lake",
                                               "lago de Zumpango"="Zumpango Lake",
                                               "laguna de La Minzita"="La Minzita Lagoon",
                                               "laguna de Magdalena"="Magdalena Lagoon",
                                               "laguna de Sta Maria"="Sta Maria Lagoon",
                                               "laguna La Colorada"="La Colorada Lagoon",
                                               "Laguna Zempoala"="Zempoala Lagoon",
                                               "manantial en 27 de Nov."="Spring at 27 de Noviembre",
                                               "manantial en El Toboso"="Spring at El Toboso",
                                               "manantial en Los Berros"="Spring at Los Berros",
                                               "manantial en Puerta del Rio"="Spring at Puerta del Rio",
                                               "manantial Molino de Chapultepec"="Spring outside of Molino de Chapultepec",
                                               "manantial/balneario en Tocumbo"="Spring at Tocumbo",
                                               "P. de Sta Catarina"="Santa Catarina Reservoir",
                                               "P. Ignacio Ramirez"="Ignacio Ramirez Reservoir",
                                               "represa en Hda. San Sebastian"="Impoundment San Sebastian",
                                               "rio 'San Pedro' en Belen del Refugio"="San Pedro River at Belen del Refugio",
                                               "rio Amborin"="Amborin River",
                                               "rio Ameca en La Vega"="Ameca River at La Vega",
                                               "rio Ameca en Los Murillos"="Ameca River at Los Murillos",
                                               "rio Ayuquila"="Ayuquila River",
                                               "rio Ayutla"="Ayutla River",
                                               "rio Barranquitas"="Barraquitas River",
                                               "rio de Comala"="De Comala River",
                                               "rio de La Laja en Atotonilco"="De La Laja en Atotonilco River",
                                               "rio de La Pola"="De La Pola River",
                                               "rio El Huizcolote"="El Huizcolote River",
                                               "rio El Mimbre"="El Mimbre River",
                                               "rio Gde. de Santiago en Ocotlan"="Gde. de Santiago River at Ocotlan",
                                               "rio Higuerilla"="Higuerilla River",
                                               "rio La Eca"="La Eca River",
                                               "rio Lerma cerca de Solis"="Lerma River close to Solis",
                                               "rio Lerma en Puerto del Valle"="Lerma River at Puerto del Valle",
                                               "rio Minatitlan en La Loma"="Minatitlan River at La Loma",
                                               "rio Salado"="Salado River",
                                               "rio Sta Maria"="Sta Maria River",
                                               "rio Tilostoc"="Tilostoc River",
                                               "rio Tunal"="Tunal River",
                                               "rio Turbio cerca de El Nopal"="Turbio River close to El Nopal",
                                               "rio Yautepec"="Yautepec River",
                                               "trib. Ayuquila River N of Cofradia de Duendes"="Tributary to Ayuquila River",
                                               "trib. rio Tamazula"="Tributary to Tamazula River",
                                               "trib. rio Tuxpan"="Tributary to Tuxpan River",
                                               "canales en El Porvenir"="Canals at El Porvenir", "lago de Chapala en Mezcala"="Lake Chapala at Mezcala", "lago de Cuitzeo"="Lake Cuitzeo", "lago de Patzcuaro"="Patzcuaro Lake", "lago de Zirahuen"="Zirahuen Lake","laguna de La Media Luna"="La Media Luna Lagoon", "laguna de San Marcos"="San Marcos Lagoon", "laguna El Barril"="El Barril Lagoon", "manantial cerca de Illescas"="Unnamed spring outside Illescas", "manantial El Sacristan"="El Sacristan Spring", "manantial en Cerro Gordo"="Unnamed spring at Cerro Gordo", "presa El Gigante"="El Gigante Reservoir", "presa sobre el rio Carrizal"="Reservoir above the Carrizal River", "rio Coscomate"="Coscomate River", "rio Cuarenta"="Cuarenta River", "rio en 6 de Enero"="River at 6 de Enero", "rio Gde. de Santiago en Poncitlan"="Grande de Santiago River at Poncitlan", "rio Marabasco"="Marabasco River", "rio Nexapa"="Nexapa River", "rio Turbio cerca de Cueramaro"="Turbio River E of Cueramaro","rio Turbio cerca de Manuel Doblado"="Turbio River NE of Manuel Doblado", "rio Turbio en San Juan de la Puerta"="Turbio River at San Juan de La Puerta", "trib. del rio Lerma en Tanhuato"="Tributary to Lerma River at Tanhuato", "manantial/balneario El Rincon"="Manantial/balneario El Rincon"))
sort(unique(NDT$SiteNameE))
```


```{r, echo=TRUE}
save(NDT, file="NDT.RData")
write.csv2(NDT, file="NDT.csv")
```
<p>&nbsp;</p>
#### **Taxonomic updates**
Taxonomic updates are made using the list of freshwater fishes from Mexico in FishBase (Froese & Pauly, 2022), Freshwater Fishes of México (Miller, 2005) and the Global Biodiversity Information Facility (GBIF).


```{r, echo=FALSE, results=TRUE}
# Manual match, short to "genus species" format
tax <- data.frame(matrix(ncol=8, nrow = 198))
names(tax) <- c("Short", "Short2", "Genus_species", "Update1", "Update2", "Source1", "Source2", "Final")
tax$Short <- as.vector(sort(unique(unlist(lapply(NDT[,c(12,14,17,20,25)],function (x) strsplit(x,","))))))
tax$Short2 <- tax$Short
tax$Short2 <- gsub("[[:punct:]]", " ", tax$Short2)               # Remove special characters
tax$Short2 <- sub("^\\s+|\\s+$", "", tax$Short2)                 # Remove initial and final spaces
tax$Short2 <- stri_trans_general(tax$Short2, id = "Latin-ASCII") # Remove accents
tax <- tax %>% distinct()
tax <- with(tax,  tax[order(Short2) , ])
tax$Genus_species <- tax$Short2
tax$Genus_species <- ifelse(tax$Short2=="", NA, tax$Genus_species)

tax$Genus_species <- plyr::revalue(tax$Genus_species, c("A   fasciatus "="Astyanax fasciatus", # There was some taxonomic uncertainty with this record. Currently in the locality it is considerd as A. mexicanus (indicated in updates)
                                                "A  aeneus"="Astyanax aeneus",
                                                "A  aphanea"="Algansea aphanea",
                                                "A  balsana"="Atherinella balsana",
                                                "A  catarinae"="Allotoca catarinae",
                                                "A  diazi"="Allotoca diazi",
                                                "A  dugesii"="Allotoca dugesii",
                                                "A  goslinei"="Allotoca goslinei",
                                                "A  hubbsi"="Allodontichthys hubbsi",
                                                "A  maculata"="Allotoca maculata",
                                                "A  mexicanus"="Astyanax mexicanus",
                                                "A  monticola"="A monticola", 
                                                # Not defined yet (2 sps with the same code)
                                                "A  nigrofasciatus"="Archocentrus nigrofasciatus",
                                                "A  polylepis"="Allodontichthys polylepis",
                                                "A  popoche"="Algansea popoche",
                                                "A  robustus"="Alloophorus robustus",
                                                "A  robustus "="Alloophorus robustus",
                                                "A  sallaei"="Aztecula sallaei",
                                                "A  tincella"="Algansea tincella",
                                                "A  tamazulae"="Allodontichthys tamazulae",
                                                "A  toweri"="Ataeniobius toweri",
                                                "A  zacapuensis"="Allotoca zacapuensis",
                                                "A  zonistius"="Allodontichthys zonistius",
                                                "Astyanax sp"="Astyanax sp",
                                                "C   bartoni"="Cichlasoma bartoni",
                                                "C  bartoni"="Cichlasoma bartoni",
                                                "C  audax"="Characodon audax",
                                                "C  beani"="Cichlasoma beani",
                                                "C  carpio"="Cyprinus carpio",
                                                "C  encaustus"="Chapalichthys encaustus",
                                                "C  istlanum"="Cichlasoma istlanum",
                                                "C  labridens"="Cichlasoma labridens",
                                                "C  lateralis"="Characodon lateralis",
                                                "C  meeki"="Cyprinodon meeki",
                                                "C  pardalis"="Chapalichthys pardalis",
                                                "D  dichroma"="Dionda dichroma",
                                                "D  mandibularis"="Dionda mandibularis",
                                                "G  atripinnis"="Goodea atripinnis",
                                                "G  cf  senilis"="Gambusia cf senilis",
                                                "G  cf  senilis  como exotico "="Gambusia cf senilis",
                                                "G  fluviatilis"="Gobiesox fluviatilis",
                                                "G  multiradiatus"="Girardinichthys multiradiatus",
                                                "G  viviparus"="Girardinichthys viviparus",
                                                "G  yucatana"="Gambusia yucatana",
                                                "Gila sp " = "Gila sp",
                                                "H  bimaculata"="Heterandria bimaculata",
                                                "H  boucardi"="Hybopsis boucardi",
                                                "H  burtoni"="Haplochromis burtoni",
                                                "H  calientis"="Hybopsis calientis",
                                                #"H  cf  cyanoguttatus"="Herichthys cf cyanoguttatus", # Removed
                                                "H  jonesii"="Heterandria jonesii",
                                                "H  turneri"="Hubbsina turneri",
                                                "Heterandria sp "="Heterandria sp",
                                                "I  dugesii"="Ictalurus dugesii",
                                                "I  furcidens"="Ilyodon furcidens",
                                                "I  mexicanus"="Ictalurus mexicanus",
                                                "I  whitei"="Ilyodon whitei",
                                                "L  macrochirus"="Lepomis macrochirus",
                                                "L  macrochirus  1965"="Lepomis macrochirus",
                                                "M  arge"="Menidia arge",
                                                "M  chapalae"="Menidia chapalae",
                                                "M  consocia"="Menidia consocia",
                                                "M  humboldtiana"="Menidia humboldtiana",
                                                "M  jordani"="Menidia jordani",
                                                "M  labarca"="Menidia labarcae",
                                                "M  mezquital"="Menidia mezquital",
                                                "M  riojai"="Menidia riojai",
                                                "M  salmoides"="Micropterus salmoides",
                                                "Menidia sp "="Menidia sp",
                                                "N  amecae"="Notropis amecae",
                                                "ninguno"="none",
                                                "O  aureus"="Oreochromis aureus",
                                                "O  niloticus"="Oreochromis niloticus",
                                                "O  mossambicus"="Oreochromis mossambicus",
                                                "Oreochromis sp"="Oreochromis sp",
                                                "Oreochromis sp "="Oreochromis sp",
                                                "P   sphenops "= "Poecilia sphenops",
                                                "P  baenschi"="Poeciliopsis baenschi",
                                                "P  balsas"="Poeciliopsis balsas",
                                                "P  butleri"="Poecilia butleri",
                                                "P  butleri  1968 "="Poecilia butleri",
                                                "P cf  butleri"="Poecilia cf butleri",
                                                "P  cf  butleri"="Poecilia cf butleri",
                                                "P  cf  sphenops"="Poecilia cf sphenops",
                                                "P  chica"="Poecilia chica",
                                                "P  gracilis"="Poeciliopsis gracilis",
                                                "P  infans"="Poeciliopsis infans",
                                                "P  mexicana"="Poecilia mexicana",
                                                "P  nigromaculatus"="Pomoxis nigromaculatus",
                                                "P  reticulata"="Poecilia reticulata",
                                                "P  sphenops"="Poecilia sphenops",
                                                "P  turneri"="Poeciliopsis turneri",
                                                "P  turrubarensis"="Poeciliopsis turrubarensis",
                                                "P  turrubarensis "="Poeciliopsis turrubarensis",
                                                "P  viriosa"="Poeciliopsis viriosa",
                                                "Poecilia cf  butleri"="Poecilia cf butleri",
                                                "Poecilia cf  sphenops"="Poecilia cf sphenops",
                                                "Poecilia sp "="Poecilia sp",
                                                "Poeciliopsis sp "="Poeciliopsis sp",
                                                "S  austrinus"="Scartomyzon austrinus",
                                                "S  bilineata"="Skiffia bilineata",
                                                "S  lermae"="Skiffia lermae",
                                                "S  multipunctatum"="Sicydium multipunctatum",
                                                "X  captivus"="Xenoophorus captivus",
                                                "X  eiseni"="Xenotoca eiseni",
                                                "X  hellerii"="Xiphophorus hellerii",
                                                "X  maculatus"="Xiphophorus maculatus",
                                                "X  melanosoma"="Xenotoca melanosoma",
                                                "X  resolanae"="Xenotaenia resolanae",
                                                "X  resolanane"="Xenotaenia resolanae",
                                                "X  variata"="Xenotoca variata",
                                                "Xiphophorus variatus"="Xiphophorus variatus",
                                                "Y  alta"="Yuriria alta",
                                                "Y  chapalae"="Yuriria chapalae",
                                                "Z  quitzeoensis"="Zoogoneticus quitzeoensis")) # First update (for the species in the 53 sites initially considered for analysis)
sort(unique(as.character(tax$Genus_species)))

tax$Genus_species <- plyr::revalue(tax$Genus_species, c("A   dugesii"="Allotoca dugesii",
                                                        "A  meeki"="Allotoca meeki",
                                                        "A  splendens"="Ameca splendens",
                                                        "C   labridens"="Cichlasoma labridens",
                                                        "C  auratus"="Carassius auratus",
                                                        "C  carpio  sin georreferencia "="Cyprinus carpio",
                                                        "C  tessellatus"="Cualac tessellatus",
                                                        "confirmamos la presencia de Z  tequila y A  splendens"="Zoogoneticus tequila, Ameca splendens",
                                                        "encontrada seca"="none",
                                                        "es la localidad "="none",
                                                        "G  affinis"="Gambusia affinis",
                                                        "G  multiradiatus "="Girardinichthys multiradiatus",
                                                        "H  cf  cyanoguttatus"="Herichthys cf cyanoguttatus",
                                                        "H  cyanoguttatus"="Herichthys cyanoguttatus",
                                                        "M  aculeata"="Menidia aculeata",
                                                        "M  attenuata"="Menidia attenuata",
                                                        "M  charari"="Menidia charari",
                                                        "M  estor"="Menidia estor",
                                                        "M  patzcuaro"="Menidia patzcuaro",
                                                        "nada"="none",
                                                        "nada  localidad no propicia"="none",
                                                        "no era la localidad buscada"="none",
                                                        "no hay vida acuatica"="none",
                                                        "O  aureus  sin georreferencia"="Oreochromis aureus",
                                                        "observamos Oreochromis"="Oreochromis sp",
                                                        "P  balsas "="Poeciliopsis balsas",
                                                        "P  latipunctata"="Poecilia latipunctata",
                                                        "P  mexicana   "="Poecilia mexicana",
                                                        "S  francesae"="Skiffia francesae",
                                                        "S  francesae "="Skiffia francesae",
                                                        "son aguas negras"="none",
                                                        "ya no existe"="none",
                                                        "Z  tequila"="Zoogoneticus tequila")) # Species left when incorporating all 83 sites

tax$Update1[tax$Genus_species=="Menidia arge"] <- "Chirostoma arge"
tax$Source1[tax$Genus_species=="Menidia arge"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia chapalae"] <- "Chirostoma chapalae"
tax$Source1[tax$Genus_species=="Menidia chapalae"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia consocia"] <- "Chirostoma consocium"
tax$Source1[tax$Genus_species=="Menidia consocia"] <- "FishBase"
# Miller (2005) is subsps consocium since it is reported in Rio Grande de Santiago.

tax$Update1[tax$Genus_species=="Menidia humboldtiana"] <- "Chirostoma humboldtianum"
tax$Source1[tax$Genus_species=="Menidia humboldtiana"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia jordani"] <- "Chirostoma jordani"
tax$Source1[tax$Genus_species=="Menidia jordani"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia labarcae"] <- "Chirostoma labarcae"
tax$Source1[tax$Genus_species=="Menidia labarcae"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia mezquital"] <- "Chirostoma jordani"
tax$Source1[tax$Genus_species=="Menidia mezquital"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia riojai"] <- "Chirostoma riojai"
tax$Source1[tax$Genus_species=="Menidia riojai"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia aculeata"] <- "Chirostoma aculeatum"
tax$Source1[tax$Genus_species=="Menidia aculeata"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia attenuata"] <- "Chirostoma attenuatum"
tax$Source1[tax$Genus_species=="Menidia attenuata"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia charari"] <- "Chirostoma charari"
tax$Source1[tax$Genus_species=="Menidia charari"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia estor"] <- "Chirostoma estor"
tax$Source1[tax$Genus_species=="Menidia estor"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia patzcuaro"] <- "Chirostoma patzcuaro"
tax$Source1[tax$Genus_species=="Menidia patzcuaro"] <- "FishBase"

tax$Update1[tax$Genus_species=="Menidia sp"] <- "Chirostoma sp"
tax$Source1[tax$Genus_species=="Menidia sp"] <- "FishBase"

tax$Update1[tax$Genus_species=="Astyanax fasciatus"] <- "Astyanax mexicanus"
tax$Source1[tax$Genus_species=="Astyanax fasciatus"] <- "Miller (2005)"

tax$Update1[tax$Genus_species=="Haplochromis burtoni"] <- "Astatotilapia burtoni"
tax$Source1[tax$Genus_species=="Haplochromis burtoni"] <- "FishBase"

tax$Update1[tax$Genus_species=="Heterandria sp"] <- "Pseudoxiphophorus sp"
tax$Source1[tax$Genus_species=="Heterandria sp"] <- "FishBase"

tax$Update1[tax$Genus_species=="Cichlasoma bartoni"] <- "Nosferatu bartoni"
tax$Source1[tax$Genus_species=="Cichlasoma bartoni"] <- "FishBase"

tax$Update1[tax$Genus_species=="Cichlasoma labridens"] <- "Nosferatu labridens"
tax$Source1[tax$Genus_species=="Cichlasoma labridens"] <- "FishBase"

tax$Update1[tax$Genus_species=="Archocentrus nigrofasciatus"] <- "Amatitlania nigrofasciata"
tax$Source1[tax$Genus_species=="Archocentrus nigrofasciatus"] <- "FishBase"

tax$Update1[tax$Genus_species=="Cichlasoma beani"] <- "Mayaheros beani"
tax$Source1[tax$Genus_species=="Cichlasoma beani"] <- "FishBase"

tax$Update1[tax$Genus_species=="Dionda dichroma"] <- "Tampichthys dichroma"
tax$Source1[tax$Genus_species=="Dionda dichroma"] <- "FishBase"

tax$Update1[tax$Genus_species=="Dionda mandibularis"] <- "Tampichthys mandibularis"
tax$Source1[tax$Genus_species=="Dionda mandibularis"] <- "FishBase"

tax$Update1[tax$Genus_species=="Heterandria bimaculata"] <- "Pseudoxiphophorus bimaculatus"    
tax$Source1[tax$Genus_species=="Heterandria bimaculata"] <- "FishBase"

tax$Update1[tax$Genus_species=="Heterandria jonesii"] <- "Pseudoxiphophorus jonesii"    
tax$Source1[tax$Genus_species=="Heterandria jonesii"] <- "FishBase"

tax$Update1[tax$Genus_species=="Hybopsis boucardi"] <- "Notropis boucardi"
tax$Source1[tax$Genus_species=="Hybopsis boucardi"] <- "FishBase"

tax$Update1[tax$Genus_species=="Hybopsis calientis"] <- "Notropis calientis"
tax$Source1[tax$Genus_species=="Hybopsis calientis"] <- "FishBase"

tax$Update1[tax$Genus_species=="Scartomyzon austrinus"] <- "Moxostoma austrinum"
tax$Source1[tax$Genus_species=="Scartomyzon austrinus"] <- "FishBase"

```
<p>&nbsp;</p>
List of species:
```{r, echo=FALSE, results=TRUE}
rownames(tax) <- NULL
tax %>%
  kbl() %>%
  kable_styling()
```
<p>&nbsp;</p>
#### **Phylogeny:**

The species name used to source data depends on the taxonomic lists of each source. Below I test that the phylogeny of all taxa can be sourced from the Fish Tree of Life using some names that are considered invalid synonyms in GBIF.

```{r, echo=TRUE}
updated <- tax[!is.na(tax$Update1),]
notupdated <- anti_join(tax, updated)
fishsps <- as.vector(c(sort(unique(notupdated$Genus_species)), sort(unique(updated$Update1)))) #117
fishsps <- gsub(" cf ", " ", fishsps)
fishsps <- fishsps[! fishsps %in% c("Astyanax sp", "Gila sp", "Pseudoxiphophorus sp", "Chirostoma sp",
                                    "Oreochromis sp",
                                    "Poecilia sp", "Poeciliopsis sp", "none", "A monticola", "NA")]

fishsps <- c(fishsps, "Algansea monticola", "Agonostomus monticola")
fishsps <- fishsps[! fishsps %in% "Zoogoneticus tequila, Ameca splendens"] # Already included individually

length(sort(unique(fishsps))) # 105

## Check if the phylogeny can be sourced:
checkphylo <- fishtree_complete_phylogeny(species=fishsps)

fishsps[fishsps=="Mayaheros beani"] <- "Cichlasoma beani"
fishsps[fishsps=="Nosferatu bartoni"] <- "Herichthys bartoni"
fishsps[fishsps=="Nosferatu labridens"] <- "Herichthys labridens"
fishsps[fishsps=="Tampichthys dichroma"] <- "Tampichthys dichromus"


checkphylo <- fishtree_complete_phylogeny(species=fishsps) # No warning issued (all sps found)

tax$Update2[tax$Update1=="Mayaheros beani"] <- "Cichlasoma beani"
tax$Source2[tax$Update1=="Mayaheros beani"] <- "Fish Tree of Life"

tax$Update2[tax$Update1=="Nosferatu bartoni"] <- "Herichthys bartoni"
tax$Source2[tax$Update1=="Nosferatu bartoni"] <- "Fish Tree of Life"

tax$Update2[tax$Update1=="Nosferatu labridens"] <- "Herichthys labridens"
tax$Source2[tax$Update1=="Nosferatu labridens"] <- "Fish Tree of Life"

tax$Update2[tax$Update1=="Tampichthys dichroma"] <- "Tampichthys dichromus"
tax$Source2[tax$Update1=="Tampichthys dichroma"] <- "Fish Tree of Life"

save(tax, file="tax.RData")
write.csv2(tax, "tax.csv")
```
<p>&nbsp;</p>

#### **Create final data subsets:**

Initially, authors compiled incidence data for a subset of more than 80 sites. However, not all of these sites can be considered for analyses.

* Some sites are removed because:
    * A reliable reconstruction of the historical assemblage was not possible (Gesundheit and Mac?as Garcia, 2018)
    * It was considered that due to the site & area characteristics, a comprehensive sampling of the assemblage could not be achieved in 2005 (Gesundheit and Mac?as Garcia, 2018)
    * Only some species (not the complete assemblage) were reported in either temporal period of the survey. This last point refers to the LCAIE collections which were focused only on G. multiradiatus.
    * Didn't exist or were no longer suitable for aquatic life in 2005 (Gesundheit and Mac?as Garcia, 2018).
    
These locations to be removed are indicated in the original dataset. Eliminating them yields a final data set of 53 sites for analyses. (NDT53)

Another subset that also includes the sites that are not suitable for aquatic life anymore in 2005 (i.e. point 4) is generated for analyses. (NDT 67)

These two objects will be used for analyses and compared.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=TRUE}
# List of localities to remove from final dataset (53):
NotIncFinal56 <- NDT[grepl("No incluida en el conjunto final de 56", NDT$Comments),]
sort(unique(NotIncFinal56$Comments))
sort(unique(NotIncFinal56$NativeFound2005))

# Kept (53):
NIF56 <- NotIncFinal56[,c(3,4)]
rownames(NIF56) <- NULL
NIF56 %>%
  kbl() %>%
  kable_styling()

LCAIE <- NDT[NDT$CatalogNumbers=="LCAIE",]
LCAIE <- LCAIE[,c(3,4)]
rownames(LCAIE) <- NULL
LCAIE %>%
  kbl() %>%
  kable_styling()
```
<p>&nbsp;</p>

53 & 67 site subsets:    
```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
sort(unique(NDT$Comments))
NDT53 <- NDT[!grepl("No incluida en el conjunto final de 56", NDT$Comments),]
sort(unique(NDT$CatalogNumbers))
NDT53 <- NDT53[!NDT53$CatalogNumbers=="LCAIE",]

save(NDT53, file="NDT53.RData")
write.csv2(NDT53, file="NDT53.csv")

Excluded <- anti_join(NDT, NDT53)
Excluded$NativeFound2005[Excluded$CatalogNumbers=="LCAIE"]

Excluded <- Excluded[!Excluded$CatalogNumbers=="LCAIE",] # Remove LCAIE collections (not all assemblage sampled)
Excluded <- Excluded[!grepl("Es dificil definir cual puede ser el pool de especies esperadas", Excluded$Comments),] # Remove sites with unreliable resonstructions of the historical assemblage
Excluded <- Excluded[!grepl("La consider? un outlier", Excluded$Comments),] # Remove outlier considered by Pablo
Excluded <- Excluded[!Excluded$NativeFound2005 %in% c("nada, es la localidad?", "nada, no era la localidad buscada"),] # removed those that might not have been the same locality
Excluded <- Excluded[!Excluded$NativeFound2005 %in% "confirmamos la presencia de Z. tequila y A. splendens",] # removed because only qualitative data could be collected in 2005

Excluded <- Excluded[!Excluded$SiteName %in% c("rio Marabasco", "laguna El Barril"),] # remove rio Marabasco, laguna el Barril (no data for the native assemblage)

NDT67 <- rbind(NDT53, Excluded)

save(NDT67, file="NDT67.RData")
write.csv2(NDT67, file="NDT67.csv")
```
<p>&nbsp;</p>

#### **Retrieve information of unidentified records:**

```{r}
# Historical Native:
NDT67[NDT67$HistoricalNatBroad %like% " sp", ]
NDT67[NDT67$HistoricalExotics %like% " sp", ] # none

NDT67[NDT67$NativeFound2005 %like% " sp", ]
NDT67[NDT67$ExoticsFound2005 %like% " sp", ]
```

##### **End of curation script**