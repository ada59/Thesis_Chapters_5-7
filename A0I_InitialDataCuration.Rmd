---
title: "Appendix 0 Data Curation"
author: "Eslava, Ada"
date: "21 Nov 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<style>
body {
text-align: justify}
</style>

###**Dataset description:**

This dataset represents the biodiversity of freshwater fish assemblages along the Trans‐Mexican Volcanic Belt, in Central Mexico. This region is the main area of distribution of the Goodeidae, a freshwater fish family endemic of Mexico.
<p>&nbsp;</p>
The dataset contains fish incidence (i.e. presence/absence) data from two time periods: historical - prior to 1989 - and contemporary - year 2005-. The sites were selected to represent the main area of occurrence of the fish in the family Goodeidae.
<p>&nbsp;</p>
Historical period: catalog data records of fish incidence were compiled, mainly, from the collection of the Zoology Museum of the University of Michigan. The compiled fish incidence reports span over ~130 y. The catalog records were completed using information on fish distributions available in the book: Freshwater Fishes of México (Miller, 2005), and local knowledge of the authors (Gesundheit and Macias Garcia, 2018). 
<p>&nbsp;</p>
Contemporary period (i.e 2005 survey): The aim of this survey was to obtain a complete inventory of all fish present in each sampling location. Sampling took place always during daylight hours and in 13 different trips over the course of the year 2005. The sampling techniques used included seining (4m2 seine net, 4mm mesh size), trapping (40‐cm‐long minnow traps, 5‐mm mesh size), and setting a gill net (20‐m2 gill net, mesh sizes of 1.3, 5.7, 7.6, and 8.9 cm). These methods were combined in order to sample fish of different sizes and living in different habitats. Sampling effort was adapted to the area and characteristics of each site in order to maximise the probabibility of sampling all species present. For more information, see Gesundheit and Macias Garcia (2018).
<p>&nbsp;</p>
Gesundheit, P, Macias Garcia, C. The role of introduced species in the decline of a highly endemic fish fauna in Central Mexico. Aquatic Conserv: Mar Freshw Ecosyst. 2018; 28: 1384– 1395.
https://doi.org/10.1002/aqc.2927
<p>&nbsp;</p>
Comments:
Efforts were made to achieve the most comprehensive depiction possible of the incidence of freshwater fish species in the surveyed sites in both the historical and the contemporary periods. 

* There are a few things to consider:
    * Possible underrepresentation of some species that are nocturnal (i.e. assemblages were surveyed only during daylight).
    * Possible underrepresentation of a few species that are known to be better sampled with electrofishing, a method that could not be used in these locations. These species are Agonostomus monticola, Sicydium multipunctatum, Ictalurus dugesii, and Ictalurus mexicanus.
    * Possible influence of the sampling season on the probability to find certain fish species.
<p>&nbsp;</p>
#### **Libraries:**

```{r, echo = TRUE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)  
library(rworldmap)
library(readxl)
library(stringdist)
library(hablar)
library(sp)
library(rgeos)
library(GeoRange)
library(kableExtra)
library(fishtree)
library(stringi)
library(data.table)
```
<p>&nbsp;</p>
#### **Read data: **
```{r, echo=TRUE, warning=FALSE, message=FALSE}
rm(list=ls())
original_data_path <- "C:/Users/Usuario/Documents/PHD/ThesisChapterMexico_I/TemporalChange_MexicanFish_C2/Lists/Original"

locs <- read.csv2(file=paste0(original_data_path, "/locs_georeferidas.csv"), h=T) # Coordinates
dtUP <- read_excel("C:/Users/Usuario/Documents/PHD/ThesisChapterMexico_I/TemporalChange_MexicanFish_C2/Lists/Original/TODO_peces agosto 2010_PGM_Comments.xlsx") 
```
<p>&nbsp;</p>
#### **Data formatting:**
Check the structure of the data files.
```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
# Locs:
dim(locs) 
sum(locs$Localidad=="")
locs <- locs[!locs$Localidad=="",] 

# Data:
dim(dtUP)
sum(dtUP$Localidad=="") 
sum(is.na(dtUP$Localidad))
dtUP <- dtUP[!is.na(dtUP$Localidad),]
head(dtUP, 2L)

# Modify some names with special characters:
names(dtUP) <- sapply(names(dtUP), function(x) stri_trans_general(x, id = "Latin-ASCII")) 

names(dtUP)[names(dtUP)=="Cuenta...9"] <- "CountHistNatCatalog"        # Native sps count Historical Catalog Records
names(dtUP)[names(dtUP)=="Cuenta...11"] <- "CountHistNatBroad"         # Native sps count Historical Broad Sense (Reconstruction)
names(dtUP)[names(dtUP)=="ampliado - catalogo"] <- "AddedHistNat(B-C)" # Difference sps count Broad Sense - Catalog 
names(dtUP)[names(dtUP)=="Cuenta...17"] <- "CountNat2005"              # Native sps count 2005
names(dtUP)[names(dtUP)=="Cuenta...22"] <- "CountNonNat2005"           # Non-native sps count 2005
names(dtUP) <- gsub(" ", "", names(dtUP), fixed = TRUE)
dtUP <- as.data.frame(dtUP)
class(dtUP)
```
<p>&nbsp;</p>

In order to assign the coordinate pairs to each locality, the name of each site in the "locs" and "dtUP" files must match.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=TRUE}
ClosestMatch = function(string, stringVector){
  stringVector[amatch(string, stringVector, maxDist=Inf)]
} # Function for approximate string matching

# Check there is correct matching of locality names between data frames:
MatchLoc <- ClosestMatch(dtUP$Localidad, locs$Localidad) 
matches <- data.frame(dtUP$Localidad, MatchLoc)

# Flag mismatches in locality names:
matches$Flags <- rep(NA, nrow(matches)) 
vec <- c(1,4,10,12,13,15,17,20,22,25,29,30,32,35,45,47,55,57,60,62,71,79,82)
matches$Flags <- ifelse(rownames(matches) %in% vec, 1 ,matches$Flags)
sum(matches$Flags==1, na.rm=TRUE) 
matchesII <- subset(matches, matches$Flags==1)

# Assign correct locality names to allow data merging:
locs$LocalidadII <- locs$Localidad
locs$LocalidadII <- plyr::revalue(locs$LocalidadII, 
                                  c("Arroyo El Conejo en Rancho El Conejo"="arroyo El Conejo",
                                    "Rio La Eca en La Eca"="rio La Eca",
                                    "Rio Coscomate en Jilotepec"="rio Coscomate",
                                    "Rio Hidalgo en Ex-Hacienda El Porvenir"="canales en El Porvenir",
                                    "Rio Tilostoc en El Salitre"= "rio Tilostoc",
                                    "Rio Yautepec en Yautepec"="rio Yautepec",
                                    "Rio Nexapa en La Galarza"="rio Nexapa",
                                    "Arroyo en Teotihuacan"="Teotihuacan",
                                    "Canales de Xochimilco cerca del embarcadero Caltongo"="canales de Xochimilco",
                                    "Lago de Cuitzeo en La Palma"="lago de Cuitzeo",
                                    "Laguna de Zacapu en Zacapu"="lago de Zacapu",
"Lago de Patzcuaro en Puacuaro"="lago de Patzcuaro",
"Lago de Zirahuen en Aguaverde"="lago de Zirahuen",
"Laguna El Barril en El Barril"="laguna El Barril",
"Arroyo Grande en el Rancho Los Murillos"="rio Ameca en Los Murillos",
"manantial/balneario en Teuchitlan"="manantial/balneario El Rincon",
                                    "Rio Santa Ma. en Santa Ma. Del Rio"="rio Sta Maria",
"Manantiales de La Media Luna"="laguna de La Media Luna",
                                    "Rio Ayuquila en Corcovado"="rio Ayuquila",
                                    "Rio de Comala en Comala"="rio de Comala",
"Rio Cuarenta en Paso de Cuarenta"="rio Cuarenta",
                                    "manantial en Tocumbo" ="manantial/balneario en Tocumbo",
                                    "tributario del Rio Tuxpan"="trib. rio Tuxpan"))

MatchLoc <- ClosestMatch(dtUP$Localidad, locs$LocalidadII) 
new_matches <- data.frame(dtUP$Localidad, MatchLoc)

# Some more names to re-type in order to allow matching: 
locs$LocalidadII <- plyr::revalue(locs$LocalidadII, c("tributario del Rio Tamazula"="trib. rio Tamazula", "presa en Los Vergeles"="Los Vergeles"))
MatchLoc <- ClosestMatch(dtUP$Localidad, locs$LocalidadII) 
new_matches <- data.frame(dtUP$Localidad, MatchLoc) # OK
```
<p>&nbsp;</p>
Create a final dataframe and add all information. 
<p>&nbsp;</p>
Translate variable names into English.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
NDT <- data.frame(matrix(ncol = 8, nrow = 83))
NDT[,1] <- dtUP$SALIDA                                                           # Trip (survey 2005)
NDT[,2] <- str_split_fixed(dtUP$MES,"-",3)[,2]                                   # Month (survey 2005)
NDT[,3] <- rep(2005,nrow(NDT))                                                   # Year (2005)
NDT[,4] <- dtUP$Localidad                                                        # Site name I
NDT[,5] <- dtUP$Cuenca                                                           # Basin
NDT[,6] <- locs$Localidad[amatch(dtUP$Localidad, locs$LocalidadII, maxDist=Inf)] # Site name II
NDT[,7] <- locs$Latitud[locs$Localidad %in% NDT$X6]                              # Latitude
NDT[,8] <- locs$Longitud[locs$Localidad %in% NDT$X6]                             # Longitude

rownames(NDT) <- 1:nrow(NDT)

identical(dtUP$Localidad, NDT$X4) #TRUE, same order
NDT <- data.frame(NDT, dtUP[,5:26])
names(NDT) <- c("Trip", "Month", "Year", "SiteName", "DrainageBasin", "SiteNameII", "Latitude", "Longitude", names(dtUP[,5:26]))

names(NDT) <- plyr::revalue(names(NDT),c("NativosEsperadossegunno.decatalogo"="HistoricalNatCatalog",
                                         "NativosEsperadosampliado"="HistoricalNatBroad",
                                         "ExoticosEsperadosNEODAT"="HistoricalExotics",
                                         "fechadecolecta"="DateCollected",
                                         "no.decolectas"="NumberCollections",
                                         "nativosnoesperados?"="NonExpectedNat?",
                                         "nativosnoesperados"="NonExpectedNat",
                                         "mismasriquezas"="SameRichness",
                                         "ExoticosEncontrados"="ExoticsFound2005",
                                         "Datosanecdoticos"="Anectodics", 
                                         "ExtintosoExtirpadosenlaLocalidad"="Extint/ExtirpatedInLoc",
                                         "Notas"="Comments",
                                         "NativosEncontrados2005"="NativeFound2005",
                                         "enc/esp"="RatioFound/Expected"))


str(NDT)
```
<p>&nbsp;</p>
Create a column that contains information on the type of water body (using SM of Gesundheit and Macias Garcia, 2018)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
NDT$SiteType <- rep(NA, nrow(NDT))
NDT$SiteName <- stri_trans_general(NDT$SiteName, id = "Latin-ASCII") # Remove accents

# Streams:
NDT$SiteType <- ifelse(NDT$DrainageBasin %in% c("El Salado", "rio Cuitzmala", 
                                                "rio Purificacion",
                                                "rio Cihuatlan", 
                                                "lagunas de Sayula"), "Stream", NDT$SiteType) # All sites in these basins are streams
NDT$SiteType <- ifelse(NDT$SiteName %in% c("rio El Mimbre", "rio Tunal", "rio Sta Maria",
                                           "rio Barranquitas", "rio Yautepec",
                                           "trib. rio Tamazula", "trib. rio Tuxpan",
                                           "rio de Comala", "arroyo La Yerbabuena",
                                           "rio Coscomate", # Assumed
                                           "rio Turbio cerca de El Nopal", "rio Tilostoc",
                                           "rio Lerma cerca de Solis", "trib. del rio 'San Pedro'"), "Stream", NDT$SiteType)

# trib. del rio 'San Pedro' is the same as Tributary to Ayuquila River N of Cofradia de Duendes.
# Correct to the second name as it is more precise:
NDT$SiteName[NDT$SiteName=="trib. del rio 'San Pedro'"] <- "trib. Ayuquila River N of Cofradia de Duendes"

# Impounded streams:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("represa en Hda. San Sebastian",
                                           "arroyo Los Pajaritos"), "Impounded stream", NDT$SiteType)

# Springs:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("manantial en El Toboso", "manantial en 27 de Nov.",
                                           "manantial en Los Berros", "manantial en Puerta del Rio",
                                           "manantial Molino de Chapultepec"), "Spring", NDT$SiteType)
# Small rivers:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("rio 'San Pedro' en Belen del Refugio",
                                           "rio Gde. de Santiago en Ocotlan",
                                           "rio Salado",
                                           "rio Ayutla",
                                           "rio Ameca en La Vega",
                                           "rio Ameca en Los Murillos",
                                           "rio de La Pola",
                                           "rio de La Laja en Atotonilco",
                                           "rio Lerma en Puerto del Valle",
                                           "rio Ayuquila",
                                           "rio Nexapa"), "Small river", NDT$SiteType)
# Shallow lakes:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("lago de Zumpango",
                                           "lago de Chalco",
                                           "Laguna Zempoala",
                                           "lago de Yuriria",
                                           "laguna de Magdalena",
                                           "laguna La Colorada",
                                           "laguna de Sta Maria",
                                           "lago de Zacapu",
                                           "lago de Cuitzeo",
                                           "lago de Patzcuaro",
                                           "lago de Chapala en Mezcala"), "Shallow lake", NDT$SiteType)

# Reservoirs:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("P. Ignacio Ramirez", "P. San Juanico", "P. Cointzio"), "Reservoir", NDT$SiteType)

# Lakes:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("lago de Zirahuen"), "Lake", NDT$SiteType)

# Canals:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("canales de Xochimilco"), 
                       "Open canals shallow lake", NDT$SiteType)
NDT$SiteType <- ifelse(NDT$SiteName %in% c("canales en Zinzimeo", "canales en El Porvenir"), 
                       "Irrigation canals", NDT$SiteType)

# Springs forming small shallow lake:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("laguna de La Minzita", "laguna de La Media Luna"), 
                       "Springs forming small shallow lake", NDT$SiteType)

# Impounded outflow of a system of springs
NDT$SiteType <- ifelse(NDT$SiteName %in% c("P. de Sta Catarina"), 
                       "Impounded outflow system of springs", NDT$SiteType)
# Modified springs:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("balneario Los Rosales",
                                           "manantial/balneario en Tocumbo",
                                           "manantial/balneario El Rincon"), 
                       "Modified spring", NDT$SiteType)

# Not habitable:
NDT$SiteType <- ifelse(NDT$SiteName %in% c("Texcoco 1", "Texcoco 2", "Teotihuacan",
                                           "manantial en Cerro Gordo", 
                                           "manantial El Sacristan",
                                           "trib. del rio Lerma en Tanhuato",
                                           "rio Gde. de Santiago en Poncitlan",
                                           "presa El Gigante", 
                                           "rio Turbio cerca de Manuel Doblado",
                                           "rio Turbio cerca de Cueramaro",
                                           "rio Turbio en San Juan de la Puerta"), "Not habitable", NDT$SiteType) # These include localities that have ceased to exist, that were found dry or with foul water.

sum(is.na(NDT$SiteType)) # OK
# NA: rio en 6 de Enero.
# NA: presa sobre el rio Carrizal 
# NA: rio Cuarenta (considerada un outlier por Pablo & Tino)
# NA: Los Vergeles
```
<p>&nbsp;</p>
* Revise temporal and spatial data:
    * Data were collected in multiple fieldwork trips during 2005 except for May and August (Gesundheit and Macias Garcia, 2018)
    * Coordinates fall in the correct geographic area.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results=FALSE}
# Temporal:
sort(unique(NDT$Month)) 
sort(unique(NDT$Year))

# Spatial:
world <- getMap(resolution = "low")
Mexmap <- "Mexico"
Mex <- world[world@data$ADMIN %in% "Mexico", ]

NDT$Longitude <- as.numeric(NDT$Longitude)
NDT$Latitude <- as.numeric(NDT$Latitude)

range(NDT$Longitude) # Rio Barraquitas missing (-)
NDT$Longitude[NDT$SiteName=="rio Barranquitas"] <- NDT$Longitude[NDT$SiteName=="rio Barranquitas"]*(-1)

range(NDT$Latitude)  # 18.51 24.62
range(NDT$Longitude) # -104.90  -98.45
```

```{r, echo=TRUE, results=TRUE, message=FALSE}
(Mmap <- ggplot() +
    geom_polygon(data = Mex, 
                 aes(x = long, y = lat, group = group),
                 fill = NA, colour = "black") + 
    geom_point(data = NDT,
               aes(x = Longitude, y = Latitude), size=2.5)+
  theme_classic())
```
<p>&nbsp;</p>
* Remove a couple dubious sps observations in the historical assemblage according to data collectors.
    * ?Z. quitzeoensis?) in "manantial Molino de Chapultepec"
    * A. regalis (?) in "manantial/balneario en Tocumbo"
* Add a few species observations:
    * Gambusia senilis considered native in "manantial en 27 de noviembre" despite the records from the historical collectors Humphries y Smith. Miller mentions similar populations possibly of G senilis in the area and, in 2005, the sps was found in two close reservoirs, so it was considered more likely that the species was native and not translocated in this locality.
  

```{r}
# HistoricalNatCatalog:
NDT$HistoricalNatCatalog[NDT$SiteName=="manantial/balneario en Tocumbo"] <- "C. pardalis" # String without A.regalis

# HistoricalNatBroad:
NDT$HistoricalNatBroad[NDT$SiteName=="manantial Molino de Chapultepec"] <- "A. diazi, G. atripinnis, S. lermae, A. dugesii, (A. robustus?, X. variata" # String without Z. quitzeoensis
NDT$HistoricalNatBroad[NDT$SiteName=="manantial/balneario en Tocumbo"] <- "G. atripinnis, C. pardalis" # String without A.regalis

# Check G. cf. senilis (manantial en 27 de noviembre):
NDT$HistoricalNatCatalog[NDT$SiteName=="manantial en 27 de Nov."]
NDT$HistoricalNatCatalog[NDT$SiteName=="manantial en 27 de Nov."] <- "C. lateralis, C. meeki, G. cf. senilis, M. mezquital"
NDT$HistoricalNatBroad[NDT$SiteName=="manantial en 27 de Nov."]
NDT$HistoricalExotics[NDT$SiteName=="manantial en 27 de Nov."]

```
<p>&nbsp;</p>
Translate site & basin Spanish names according to Gesundheit & Macias-Garcia (2018):

```{r, echo=TRUE}
sort(unique(NDT$DrainageBasin))

NDT$DrainageBasinE <- NA
NDT$SiteNameE <- NA

NDT$DrainageBasinE <- plyr::revalue(NDT$DrainageBasin, c("alto Lerma"="Upper Lerma",
                                                        "de Mexico"="Valley of Mexico",
                                                        "El Salado"="El Salado",
                                                        "lago de Cuitzeo"="Lake Cuitzeo",
                                                        "lago de Patzcuaro"="Lake Patzcuaro",
                                                        "lago de Yuriria"="Lake Yuriria",
                                                        "lagunas de Sayula"="Sayula Lagoons",
                                                        "medio Lerma"="Middle Lerma",
                                                        "rio Ameca"="Ameca River",
                                                        "rio Armeria"="Armeria River",
                                                        "rio Balsas"="Balsas River",
                                                        "rio Cihuatlan"="Cihuatlan River",
                                                        "rio Cuitzmala"="Cuitzmala River",
                                                        "rio Gde. de Santiago"="Grande de Santiago River",
                                                        "rio Naranjo - Coahuayana"="Naranjo - Coahuayana River",
                                                        "rio Panuco"="Panuco River",
                                                        "rio Purificacion"="Purificacion River",
                                                        "rio San Pedro Mezquital"="San Pedro Mezquital River", "bajo Lerma"="Lower Lerma", "lago de Zirahuen"="Lake Zirahuen"))
sort(unique(NDT$DrainageBasinE))

sort(unique(NDT$SiteName))
NDT$SiteNameE <- plyr::revalue(NDT$SiteName, c("arroyo El Conejo"="El Conejo Stream",
                                               "arroyo en Acatlan"="Stream at Acatlan de Juarez",
                                               "arroyo en Agua de Enmedio"="Stream at Agua de Enmedio",
                                               "arroyo La Yerbabuena"="La Yerbabuena Stream",
                                               "arroyo Los Pajaritos"="Los Pajaritos Stream",
                                               "balneario Los Rosales"="Balneario Los Rosales",
                                               "canales de Xochimilco"="Xochimilco Canals",
                                               "canales en Zinzimeo"="Zinzimeo Canals",
                                               "lago de Chalco"="Lake Chalco",
                                               "lago de Yuriria"="Lake Yuriria",
                                               "lago de Zacapu"="Zacapu Lake",
                                               "lago de Zumpango"="Zumpango Lake",
                                               "laguna de La Minzita"="La Minzita Lagoon",
                                               "laguna de Magdalena"="Magdalena Lagoon",
                                               "laguna de Sta Maria"="Sta Maria Lagoon",
                                               "laguna La Colorada"="La Colorada Lagoon",
                                               "Laguna Zempoala"="Zempoala Lagoon",
                                               "manantial en 27 de Nov."="Spring at 27 de Noviembre",
                                               "manantial en El Toboso"="Spring at El Toboso",
                                               "manantial en Los Berros"="Spring at Los Berros",
                                               "manantial en Puerta del Rio"="Spring at Puerta del Rio",
                                               "manantial Molino de Chapultepec"="Spring outside of Molino de Chapultepec",
                                               "manantial/balneario en Tocumbo"="Spring at Tocumbo",
                                               "P. de Sta Catarina"="Santa Catarina Reservoir",
                                               "P. Ignacio Ramirez"="Ignacio Ramirez Reservoir",
                                               "represa en Hda. San Sebastian"="Impoundment San Sebastian",
                                               "rio 'San Pedro' en Belen del Refugio"="San Pedro River at Belen del Refugio",
                                               "rio Amborin"="Amborin River",
                                               "rio Ameca en La Vega"="Ameca River at La Vega",
                                               "rio Ameca en Los Murillos"="Ameca River at Los Murillos",
                                               "rio Ayuquila"="Ayuquila River",
                                               "rio Ayutla"="Ayutla River",
                                               "rio Barranquitas"="Barraquitas River",
                                               "rio de Comala"="De Comala River",
                                               "rio de La Laja en Atotonilco"="De La Laja en Atotonilco River",
                                               "rio de La Pola"="De La Pola River",
                                               "rio El Huizcolote"="El Huizcolote River",
                                               "rio El Mimbre"="El Mimbre River",
                                               "rio Gde. de Santiago en Ocotlan"="Grande de Santiago River at Ocotlan",
                                               "rio Higuerilla"="Higuerilla River",
                                               "rio La Eca"="La Eca River",
                                               "rio Lerma cerca de Solis"="Lerma River close to Solis",
                                               "rio Lerma en Puerto del Valle"="Lerma River at Puerto del Valle",
                                               "rio Minatitlan en La Loma"="Minatitlan River at La Loma",
                                               "rio Salado"="Salado River",
                                               "rio Sta Maria"="Sta Maria River",
                                               "rio Tilostoc"="Tilostoc River",
                                               "rio Tunal"="Tunal River",
                                               "rio Turbio cerca de El Nopal"="Turbio River close to El Nopal",
                                               "rio Yautepec"="Yautepec River",
                                               "trib. Ayuquila River N of Cofradia de Duendes"="Tributary to Ayuquila River",
                                               "trib. rio Tamazula"="Tributary to Tamazula River",
                                               "trib. rio Tuxpan"="Tributary to Tuxpan River",
                                               "canales en El Porvenir"="Canals at El Porvenir", "lago de Chapala en Mezcala"="Lake Chapala at Mezcala", "lago de Cuitzeo"="Lake Cuitzeo", "lago de Patzcuaro"="Patzcuaro Lake", "lago de Zirahuen"="Zirahuen Lake","laguna de La Media Luna"="La Media Luna Lagoon", "laguna de San Marcos"="San Marcos Lagoon", "laguna El Barril"="El Barril Lagoon", "manantial cerca de Illescas"="Unnamed spring outside Illescas", "manantial El Sacristan"="El Sacristan Spring", "manantial en Cerro Gordo"="Unnamed spring at Cerro Gordo", "presa El Gigante"="El Gigante Reservoir", "presa sobre el rio Carrizal"="Reservoir above the Carrizal River", "rio Coscomate"="Coscomate River", "rio Cuarenta"="Cuarenta River", "rio en 6 de Enero"="River at 6 de Enero", "rio Gde. de Santiago en Poncitlan"="Grande de Santiago River at Poncitlan", "rio Marabasco"="Marabasco River", "rio Nexapa"="Nexapa River", "rio Turbio cerca de Cueramaro"="Turbio River E of Cueramaro","rio Turbio cerca de Manuel Doblado"="Turbio River NE of Manuel Doblado", "rio Turbio en San Juan de la Puerta"="Turbio River at San Juan de La Puerta", "trib. del rio Lerma en Tanhuato"="Tributary to Lerma River at Tanhuato", "manantial/balneario El Rincon"="Manantial/balneario El Rincon"))
sort(unique(NDT$SiteNameE))
```


```{r, echo=TRUE}
path_lists <- "C:/Users/Usuario/Documents/PHD/ThesisChapterMexico_I/TemporalChange_MexicanFish_C2/Lists"
save(NDT, file=paste0(path_lists, "/NDT.RData"))
write.csv2(NDT, file=paste0(path_lists, "/NDT.csv"))
```
<p>&nbsp;</p>
#### **Taxonomic updates**
Taxonomic updates are made using the Eschmeyer's Catalog of Fishes - version of 4 April 2023.
https://www.calacademy.org/scientists/projects/eschmeyers-catalog-of-fishes

```{r, echo=FALSE, results=TRUE}
# Manual match, short to "genus species" format
count_unique <- as.vector(sort(unique(unlist(lapply(NDT[,c(12,14,17,20,25,28)], function (x) strsplit(x,",")))))) # 205

tax <- data.frame(matrix(ncol=7, nrow = 205))
names(tax) <- c("Short", "Short2", "Genus_species", "Synonym", "Update", "Update_comment", "Genus_species_ECF")
tax$Short <- as.vector(sort(unique(unlist(lapply(NDT[,c(12,14,17,20,25,28)],function (x) strsplit(x,","))))))
tax$Short2 <- tax$Short
tax$Short2 <- gsub("[[:punct:]]", " ", tax$Short2)               # Remove special characters
tax$Short2 <- sub("^\\s+|\\s+$", "", tax$Short2)                 # Remove initial and final spaces
tax$Short2 <- stri_trans_general(tax$Short2, id = "Latin-ASCII") # Remove accents
tax <- tax %>% distinct()
tax <- with(tax,  tax[order(Short2) , ])
tax$Genus_species <- tax$Short2
tax$Genus_species <- ifelse(tax$Short2=="", NA, tax$Genus_species)

sort(unique(tax$Short2))

tax$Genus_species <- plyr::revalue(tax$Genus_species, c("A   dugesii"="Allotoca dugesii",
                                                        "A   fasciatus "="Astyanax fasciatus", 
                                                "A  aeneus"="Astyanax aeneus",
                                                "A  aphanea"="Algansea aphanea",
                                                "A  balsana"="Atherinella balsana",
                                                "A  catarinae"="Allotoca catarinae",
                                                "A  diazi"="Allotoca diazi",
                                                "A  dugesii"="Allotoca dugesii",
                                                "A  goslinei"="Allotoca goslinei",
                                                "A  hubbsi"="Allodontichthys hubbsi",
                                                "A  maculata"="Allotoca maculata",
                                                "A  meeki"="Allotoca meeki",
                                                "A  mexicanus"="Astyanax mexicanus",
                                                "A  monticola"="A monticola", 
                                                # Not defined yet (2 sps with the same code)
                                                "A  nigrofasciatus"="Archocentrus nigrofasciatus",
                                                "A  polylepis"="Allodontichthys polylepis",
                                                "A  popoche"="Algansea popoche",
                                                "A  robustus"="Alloophorus robustus",
                                                "A  robustus "="Alloophorus robustus",
                                                "A  sallaei"="Aztecula sallaei",
                                                "A  splendens"="Ameca splendens",
                                                "A  tincella"="Algansea tincella",
                                                "A  tamazulae"="Allodontichthys tamazulae",
                                                "A  toweri"="Ataeniobius toweri",
                                                "A  zacapuensis"="Allotoca zacapuensis",
                                                "A  zonistius"="Allodontichthys zonistius",
                                                "Astyanax sp"="Astyanax sp",
                                                "bagre y lobina"="Bagre sp & Micropterus salmoides",
                                                "C   bartoni"="Cichlasoma bartoni",
                                                "C   labridens"="Cichlasoma labridens",
                                                "C  bartoni"="Cichlasoma bartoni",
                                                "C  audax"="Characodon audax",
                                                "C  auratus"="Carassius auratus",
                                                "C  beani"="Cichlasoma beani",
                                                "C  carpio"="Cyprinus carpio",
                                                "C  carpio  sin georreferencia "="Cyprinus carpio",
                                                "C  encaustus"="Chapalichthys encaustus",
                                                "C  istlanum"="Cichlasoma istlanum",
                                                "C  labridens"="Cichlasoma labridens",
                                                "C  lateralis"="Characodon lateralis",
                                                "C  tessellatus"="Cualac tessellatus",
                                                "carpa"="Cyprinus carpio",
                                                "carpas"="Cyprinus carpio",
                                                "C  meeki"="Cyprinodon meeki",
                                                "C  pardalis"="Chapalichthys pardalis",
                                                "confirmamos la presencia de Z  tequila y A  splendens"="Zoogoneticus tequila y Ameca  splendens",
                                                "D  dichroma"="Dionda dichroma",
                                                "D  mandibularis"="Dionda mandibularis",
                                                "encontrada seca"="Dry",
                                                "es la localidad "="is the locality",
                                                "G  affinis"="Gambusia affinis",
                                                "G  atripinnis"="Goodea atripinnis",
                                                "G  cf  senilis"="Gambusia cf senilis",
                                                "G  fluviatilis"="Gobiesox fluviatilis",
                                                "G  multiradiatus "="Girardinichthys multiradiatus",
                                                "G  multiradiatus"="Girardinichthys multiradiatus",
                                                "G  viviparus"="Girardinichthys viviparus",
                                                "G  yucatana"="Gambusia yucatana",
                                                "Gila sp " = "Gila sp",
                                                "H  bimaculata"="Heterandria bimaculata",
                                                "H  boucardi"="Hybopsis boucardi",
                                                "H  burtoni"="Haplochromis burtoni",
                                                "H  calientis"="Hybopsis calientis",
                                                "H  cf  cyanoguttatus"="Herichthys cf cyanoguttatus", 
                                                "H  cyanoguttatus"="Herichthys cyanoguttatus",
                                                "H  jonesii"="Heterandria jonesii",
                                                "H  turneri"="Hubbsina turneri",
                                                "Heterandria sp"="Heterandria sp",
                                                "Heterandria sp "="Heterandria sp",
                                                "I  dugesii"="Ictalurus dugesii",
                                                "I  furcidens"="Ilyodon furcidens",
                                                "I  mexicanus"="Ictalurus mexicanus",
                                                "I  whitei"="Ilyodon whitei",
                                                "juiles "="Rhamdia sp",
                                                "L  macrochirus"="Lepomis macrochirus",
                                                "L  macrochirus  1965"="Lepomis macrochirus",
                                                "M  aculeata"="Menidia aculeata",
                                                "M  arge"="Menidia arge",
                                                "M  attenuata"="Menidia attenuata",
                                                "M  chapalae"="Menidia chapalae",
                                                "M  charari"="Menidia charari",
                                                "M  consocia"="Menidia consocia",
                                                "M  estor"="Menidia estor",
                                                "M  humboldtiana"="Menidia humboldtiana",
                                                "M  jordani"="Menidia jordani",
                                                "M  labarca"="Menidia labarcae",
                                                "M  mezquital"="Menidia mezquital",
                                                "M  patzcuaro"="Menidia patzcuaro",
                                                "M  riojai"="Menidia riojai",
                                                "M  salmoides"="Micropterus salmoides",
                                                "Menidia sp "="Menidia sp",
                                                "N  amecae"="Notropis amecae",
                                                "nada"="none",
                                                "nada  localidad no propicia"="none",
                                                "ninguno"="none",
                                                "no era la localidad buscada"="it was not the right locality",
                                                "no hay vida acuatica"="no aquatic life",
                                                "O  aureus"="Oreochromis aureus",
                                                "O  aureus  sin georreferencia"="Oreochromis aureus",
                                                "O  niloticus"="Oreochromis niloticus",
                                                "observamos Oreochromis"="Oreochromis sp",
                                                "O  mossambicus"="Oreochromis mossambicus",
                                                "Oreochromis sp"="Oreochromis sp",
                                                "Oreochromis sp "="Oreochromis sp",
                                                "P   sphenops "= "Poecilia sphenops",
                                                "P  baenschi"="Poeciliopsis baenschi",
                                                "P  balsas"="Poeciliopsis balsas",
                                                "P  balsas "="Poeciliopsis balsas",
                                                "P  butleri"="Poecilia butleri",
                                                "P  butleri  1968 "="Poecilia butleri",
                                                "P cf  butleri"="Poecilia cf butleri",
                                                "P  cf  butleri"="Poecilia cf butleri",
                                                "P  cf  sphenops"="Poecilia cf sphenops",
                                                "P  chica"="Poecilia chica",
                                                "P  gracilis"="Poeciliopsis gracilis",
                                                "P  infans"="Poeciliopsis infans",
                                                "P  mexicana"="Poecilia mexicana",
                                                "P  mexicana   "="Poecilia mexicana",
                                                "P  nigromaculatus"="Pomoxis nigromaculatus",
                                                "P  reticulata"="Poecilia reticulata",
                                                "P  sphenops"="Poecilia sphenops",
                                                "P  turneri"="Poeciliopsis turneri",
                                                "P  turrubarensis"="Poeciliopsis turrubarensis",
                                                "P  turrubarensis "="Poeciliopsis turrubarensis",
                                                "P  viriosa"="Poeciliopsis viriosa",
                                                "Poecilia cf  butleri"="Poecilia cf butleri",
                                                "Poecilia cf  sphenops"="Poecilia cf sphenops",
                                                "Poecilia sp "="Poecilia sp",
                                                "Poeciliopsis sp "="Poeciliopsis sp",
                                                "P  latipunctata"="Poecilia latipunctata",
                                                "S  austrinus"="Scartomyzon austrinus",
                                                "S  bilineata"="Skiffia bilineata",
                                                "S  francesae"="Skiffia francesae",
                                                "S  francesae "="Skiffia francesae",
                                                "S  lermae"="Skiffia lermae",
                                                "S  multipunctatum"="Sicydium multipunctatum",
                                                "son aguas negras"="foul water",
                                                "trompos "="?",
                                                "trucha arcoiris"="Oncorhynchus mykiss",
                                                "X  captivus"="Xenoophorus captivus",
                                                "X  eiseni"="Xenotoca eiseni",
                                                "X  hellerii"="Xiphophorus hellerii",
                                                "X  maculatus"="Xiphophorus maculatus",
                                                "X  melanosoma"="Xenotoca melanosoma",
                                                "X  resolanae"="Xenotaenia resolanae",
                                                "X  resolanane"="Xenotaenia resolanae",
                                                "X  variata"="Xenotoca variata",
                                                "Xiphophorus variatus"="Xiphophorus variatus",
                                                "Y  alta"="Yuriria alta",
                                                "Y  chapalae"="Yuriria chapalae",
                                                "ya no existe"="ceased to exist",
                                                "Z  quitzeoensis"="Zoogoneticus quitzeoensis",
                                                "Z  tequila"="Zoogoneticus tequila")) 
sort(unique(as.character(tax$Genus_species)))

# Populate other table sections:

# Synonyms (TRUE or FALSE):
tax$Synonym <- ifelse(tax$Genus_species %in% c("Archocentrus nigrofasciatus",
                                               "Cichlasoma bartoni",
                                               "Cichlasoma beani",
                                               "Cichlasoma istlanum",
                                               "Cichlasoma labridens",
                                               "Dionda dichroma",
                                               "Dionda mandibularis",
                                               "Heterandria bimaculata",
                                               "Hybopsis boucardi",
                                               "Haplochromis burtoni",
                                               "Hybopsis calientis",
                                               "Heterandria jonesii",
                                               "Heterandria sp",
                                               "Hubbsina turneri",
                                               "Menidia aculeata",
                                               "Menidia arge",
                                               "Menidia attenuata",
                                               "Menidia chapalae",
                                               "Menidia charari",
                                               "Menidia consocia",
                                               "Menidia estor",
                                               "Menidia humboldtiana",
                                               "Menidia jordani", 
                                               "Menidia labarcae", 
                                               "Menidia mezquital",
                                               "Menidia patzcuaro",
                                               "Menidia riojai",
                                               "Menidia sp",
                                               "Scartomyzon austrinus",
                                               "Skiffia bilineata"), "TRUE", "FALSE")
tax$Synonym <- ifelse(tax$Genus_species %in% c("Dry", "is the locality", 
                                               "none", "it was not the right locality",
                                               "no aquatic life", "foul water", "?",
                                               "ceased to exist"), NA, tax$Synonym)

# Comments:
tax$Update[tax$Genus_species=="Astyanax fasciatus"] <- "Astyanax mexicanus"
tax$Update_comment[tax$Genus_species=="Astyanax fasciatus"] <- "Some taxonomic uncertainty with this record. Currently in the locality it is considered as A. mexicanus"

tax$Update[tax$Genus_species=="Menidia consocia"] <- "TBD1"
tax$Update_comment[tax$Genus_species=="Menidia consocia"] <- "Could be C chapalae or C reseratum"
tax$Update[tax$Genus_species=="Menidia patzcuaro"] <- "TBD2"
tax$Update_comment[tax$Genus_species=="Menidia patzcuaro"] <- "Could be C attenuatum or C estor"
tax$Update[tax$Genus_species=="Scartomyzon austrinus"] <- "TBD3"
tax$Update_comment[tax$Genus_species=="Scartomyzon austrinus"] <- "Could be M austrinum or M milleri"

# Clear updates:

tax$Update[tax$Genus_species=="Archocentrus nigrofasciatus"] <- "Amatitlania nigrofasciata"
tax$Update[tax$Genus_species=="Cichlasoma bartoni"] <- "Herichthys bartoni"
tax$Update[tax$Genus_species=="Cichlasoma beani"] <- "Mayaheros beani"
tax$Update[tax$Genus_species=="Cichlasoma istlanum"] <- "Amphilophus istlanus"
tax$Update[tax$Genus_species=="Cichlasoma labridens"] <- "Herichthys labridens"
tax$Update[tax$Genus_species=="Dionda dichroma"] <- "Tampichthys dichroma"
tax$Update[tax$Genus_species=="Dionda mandibularis"] <- "Tampichthys mandibularis"
tax$Update[tax$Genus_species=="Heterandria bimaculata"] <- "Pseudoxiphophorus bimaculatus"
tax$Update[tax$Genus_species=="Hybopsis boucardi"] <- "Notropis boucardi"
tax$Update[tax$Genus_species=="Haplochromis burtoni"] <- "Astatotilapia burtoni"
tax$Update[tax$Genus_species=="Hybopsis calientis"] <- "Notropis calientis"
tax$Update[tax$Genus_species=="Heterandria jonesii"] <- "Pseudoxiphophorus jonesii"
tax$Update[tax$Genus_species=="Heterandria sp"] <- "Pseudoxiphophorus sp"
tax$Update[tax$Genus_species=="Hubbsina turneri"] <- "Girardinichthys turneri"
tax$Update[tax$Genus_species=="Menidia aculeata"] <- "Chirostoma aculeatum"
tax$Update[tax$Genus_species=="Menidia arge"] <- "Chirostoma arge"
tax$Update[tax$Genus_species=="Menidia attenuata"] <- "Chirostoma attenuatum"
tax$Update[tax$Genus_species=="Menidia chapalae"] <- "Chirostoma chapalae"
tax$Update[tax$Genus_species=="Menidia charari"] <- "Chirostoma charari"
tax$Update[tax$Genus_species=="Menidia estor"] <- "Chirostoma estor"
tax$Update[tax$Genus_species=="Menidia humboldtiana"] <- "Chirostoma humboldtianum"
tax$Update[tax$Genus_species=="Menidia jordani"] <- "Chirostoma jordani"
tax$Update[tax$Genus_species=="Menidia labarcae"] <- "Chirostoma labarcae"
tax$Update[tax$Genus_species=="Menidia mezquital"] <- "Chirostoma mezquital"
tax$Update[tax$Genus_species=="Menidia riojai"] <- "Chirostoma riojai"
tax$Update[tax$Genus_species=="Menidia sp"] <- "Chirostoma sp"
tax$Update[tax$Genus_species=="Skiffia bilineata"] <- "Neotoca bilineata"

sum(is.na(tax$Synonym))
tax$Short2[is.na(tax$Synonym)] # non species

tax$Genus_species_ECF <- ifelse(is.na(tax$Update), tax$Genus_species, tax$Update)
tax$Genus_species_ECF <- ifelse(is.na(tax$Genus_species), tax$Short, tax$Genus_species_ECF)


path_lists <- "C:/Users/Usuario/Documents/PHD/ThesisChapterMexico_I/TemporalChange_MexicanFish_C2/Lists"

save(tax, file=paste0(path_lists, "/tax.RData"))
write.csv2(tax, file=paste0(path_lists, "/tax.csv"))
```
<p>&nbsp;</p>

#### **Create final data subsets:**

Initially, authors compiled incidence data for a subset of more than 80 sites. 

I generate different subsets of these site list. The purpose is to use them for different analyses and for sensitivity tests.

*SUBSET 1:*
In this subset, some sites are removed because:
    * A reliable reconstruction of the historical assemblage was not possible (Gesundheit and Macias Garcia, 2018)
    * It was considered that due to the site & area characteristics, a comprehensive sampling of the assemblage could not be achieved in 2005 (Gesundheit and Macias Garcia, 2018)
    * Only some species (not the complete assemblage) were reported in either temporal period of the survey. This last point refers to the LCAIE collections which were focused only on G. multiradiatus.
    * Didn't exist or were no longer suitable for aquatic life in 2005 (Gesundheit and Macias Garcia, 2018).
    
These locations to be removed are indicated in the original dataset. Eliminating them yields a final data set of 53 sites for analyses. (NDT53)

*SUBSET 2:*
Another subset that also includes the sites that are not suitable for aquatic life anymore in 2005 (i.e. point 4) is generated for analyses. (NDT 67)


*SUBSET 3:*
-Historical species list (narrow): all species reported in the catalogs for any site are included.

-Historical species list (broad): all species reported in any site are included.

-Contemporary: all species monitored in any site in 2005.



```{r, echo=TRUE, warning=FALSE, message=FALSE, results=TRUE}
# Create subsets of data:
path_lists <- "C:/Users/Usuario/Documents/PHD/ThesisChapterMexico_I/TemporalChange_MexicanFish_C2/Lists"
length(unique(NDT$SiteName)) # 83

# SUBSET 1:

NotIncFinal56 <- NDT[grepl("No incluida en el conjunto final de 56", NDT$Comments),]
sort(unique(NotIncFinal56$Comments))
sort(unique(NotIncFinal56$NativeFound2005)) # 27 locations

LCAIE <- NDT[NDT$CatalogNumbers=="LCAIE",]  # 5 locations

sort(unique(NDT$Comments))
NDT53 <- NDT[!grepl("No incluida en el conjunto final de 56", NDT$Comments),]
sort(unique(NDT$CatalogNumbers))
NDT53 <- NDT53[!NDT53$CatalogNumbers=="LCAIE",]

save(NDT53, file=paste0(path_lists, "/NDT53.RData"))
write.csv2(NDT53, file=paste0(path_lists, "/NDT53.csv"))

# SUBSET 2:
Excluded <- anti_join(NDT, NDT53)
Excluded$NativeFound2005[Excluded$CatalogNumbers=="LCAIE"]

Excluded <- Excluded[!Excluded$CatalogNumbers=="LCAIE",] # Remove LCAIE collections (not all assemblage sampled)
Excluded <- Excluded[!grepl("Es dificil definir cual puede ser el pool de especies esperadas", Excluded$Comments),] # Remove sites with unreliable resonstructions of the historical assemblage
Excluded <- Excluded[!grepl("La consider? un outlier", Excluded$Comments),] # Remove outlier considered by Pablo
Excluded <- Excluded[!Excluded$NativeFound2005 %in% c("nada, es la localidad?", "nada, no era la localidad buscada"),] # removed those that might not have been the same locality
Excluded <- Excluded[!Excluded$NativeFound2005 %in% "confirmamos la presencia de Z. tequila y A. splendens",] # removed because only qualitative data could be collected in 2005
Excluded <- Excluded[!Excluded$SiteName %in% c("rio Marabasco", "laguna El Barril"),] # remove rio Marabasco, laguna el Barril (no data for the native assemblage)

NDT67 <- rbind(NDT53, Excluded)

save(NDT67, file=paste0(path_lists, "/NDT67.RData"))
write.csv2(NDT67, file=paste0(path_lists, "/NDT67.csv"))

list53_67 <- anti_join(NDT67, NDT53)
save(list53_67, file=paste0(path_lists, "/list53_67.RData"))
write.csv2(list53_67, file=paste0(path_lists, "/list53_67.csv"))

# SUBSET 3:
NDT83 <- NDT
save(NDT83, file=paste0(path_lists, "/NDT83.RData"))
write.csv2(NDT83, file=paste0(path_lists, "/NDT83.csv"))

list67_83 <- anti_join(NDT83, NDT67)
save(list67_83, file=paste0(path_lists, "/list67_83.RData"))
write.csv2(list67_83, file=paste0(path_lists, "/list67_83.csv"))

```
<p>&nbsp;</p>

##### **End of curation script**